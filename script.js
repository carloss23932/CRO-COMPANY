// قاموس الترجمة - يحتوي على جميع النصوص العربية والإنجليزية
const translations = {
    'en': {
        // العناوين العامة والتنقل
        pageTitle: 'CRO - App Development',
        navAbout: 'About Us',
        navPortfolio: 'Our Apps',
        navUpdates: 'Updates',
        navContact: 'Contact',
        heroHeading: 'Android Innovators: Turning Your Ideas into Outstanding Digital Applications.',
        heroText: 'Specialized solutions in Android app development and professional user interface design.',
        heroCTA: 'Start Your Project Now',
        
        // قسم من نحن والخدمات
        aboutHeading: 'Who We Are?',
        aboutText: 'At **CRO**, we are a specialized team of developers and UI/UX designers passionate about creating innovative Android applications and exceptional user interfaces. Our mission is to help businesses reach millions of Android users through high-performance apps and attractive designs.',
        servicesHeading: 'Our Core Services',
        service1Title: 'Android App Development',
        service1Text: 'Building innovative and high-performance Android applications using the latest technologies like Kotlin and Java. Apps compatible with all Android versions.',
        service2Title: 'User Interface/Experience Design (UI/UX)',
        service2Text: 'We design modern and attractive user interfaces following the latest Material Design standards. Smooth and enjoyable user experience that ensures customer retention.',
        service3Title: 'App Development & Enhancement',
        service3Text: 'We analyze and improve existing applications, enhance performance and add new features. Specialized consulting services.',
        
        // قسم التطبيقات (Portfolio)
        portfolioHeading: 'Our Published Apps',
        portfolioSubText: 'Here are some of our outstanding projects that have made a difference in the market.',
        
        // التطبيق الأول
        app1Title: 'AndroidShop - Smart Store',
        app1Desc: 'Advanced Android e-commerce app providing seamless shopping experience with modern Material Design interface. Supports electronic payments and real-time tracking.',
        app1CTA: 'Download Now',

        // التطبيق الثاني
        app2Title: 'TaskPro Android',
        app2Desc: 'Advanced Android task management app with intelligent user interface. Features AI capabilities and instant synchronization. Increased client productivity by 50%.',
        app2CTA: 'Download Now',
        
        // التطبيق الثالث
        app3Title: 'UI Showcase - Interface Gallery',
        app3Desc: 'Android app showcasing our latest UI/UX designs. Innovative interfaces following Material Design 3 with advanced interactive effects.',
        app3CTA: 'Visit Gallery',
        
        // قسم الأخبار (Updates)
        updatesHeading: 'Latest News and Posts',
        post1Title: 'New Partnership with Saudi Bank',
        post1Desc: 'We are delighted to announce our strategic collaboration to develop the pioneering FinTech Pro app in the financial technology sector.',
        post1Link: 'Read More',
        post2Title: 'Launching the New AI Assistant Feature',
        post2Desc: 'We have updated the TaskManager Pro app by adding the long-awaited AI Assistant feature to greatly enhance user experience.',
        post2Link: 'Read More',
        
        // قسم التواصل (Contact)
        contactHeading: 'Contact Us',
        contactLead: 'Our team is waiting for you! Get in touch today to turn your idea into reality. Send us a message or contact us via the details below.',
        contactPhoneLabel: 'Phone',
        contactPhoneDesc: 'For direct contact and instant inquiry',
        directCallBtn: 'Direct Call',
        whatsappBtn: 'WhatsApp',
        contactFormTitle: 'Send Us a Message',
        sendBtn: 'Send Message',
        
        // الخدمات في النموذج
        serviceDefault: 'Choose Required Service',
        serviceAndroid: 'Android App Development',
        serviceUiux: 'UI/UX Design',
        serviceImprovement: 'App Development & Enhancement',
        serviceConsultation: 'Technical Consultation',
        
        // نصوص الـ placeholders
        namePlaceholder: 'Full Name',
        emailPlaceholder: 'Email Address',
        phonePlaceholder: 'Phone Number',
        messagePlaceholder: 'Write your message here...',
        
        // التذييل
        footerServicesTitle: 'Our Services',
        footerContactTitle: 'Contact Us',
        footerServiceAndroid: 'Android Development',
        footerServiceUiux: 'UI/UX Design',
        footerServiceImprovement: 'App Enhancement',
        footerText: '© 2024. CRO. All rights reserved.'
    },
    'ar': {
        // العناوين العامة والتنقل
        pageTitle: 'CRO - تطوير التطبيقات',
        navAbout: 'من نحن',
        navPortfolio: 'تطبيقاتنا',
        navUpdates: 'الأخبار',
        navContact: 'اتصل بنا',
        heroHeading: 'مبدعون في تطوير أندرويد: نحول أفكارك إلى تطبيقات رقمية متميزة.',
        heroText: 'حلول متخصصة في تطوير تطبيقات أندرويد وتصميم واجهات مستخدم احترافية.',
        heroCTA: 'ابدأ مشروعك الآن',
        
        // قسم من نحن والخدمات
        aboutHeading: 'من نحن؟',
        aboutText: 'نحن في **سي آر أو**، فريق متخصص من المطورين ومصممي الواجهات الشغوفين بإنشاء تطبيقات أندرويد مبتكرة وواجهات مستخدم استثنائية. رسالتنا هي تمكين الشركات من الوصول إلى ملايين مستخدمي أندرويد عبر تطبيقات عالية الأداء وتصميمات جذابة.',
        servicesHeading: 'خدماتنا الأساسية',
        service1Title: 'تطوير تطبيقات أندرويد',
        service1Text: 'بناء تطبيقات أندرويد مبتكرة وعالية الأداء باستخدام أحدث التقنيات مثل كوتلن و جافا. تطبيقات متوافقة مع جميع إصدارات أندرويد.',
        service2Title: 'تصميم واجهات المستخدم',
        service2Text: 'نصمم واجهات مستخدم حديثة وجذابة تتبع أحدث معايير التصميم العصري. تجربة مستخدم سلسة وممتعة تضمن عودة العملاء.',
        service3Title: 'تطوير وتحسين التطبيقات',
        service3Text: 'نقوم بتحليل وتحسين التطبيقات القائمة، ورفع مستوى الأداء وإضافة ميزات جديدة. خدمات استشارية متخصصة.',
        
        // قسم التطبيقات (Portfolio)
        portfolioHeading: 'تطبيقاتنا المنشورة',
        portfolioSubText: 'إليك بعض من أبرز مشاريعنا التي أحدثت فرقًا في السوق.',
        
        // التطبيق الأول
        app1Title: 'متجر أندرويد شوب - متجر ذكي',
        app1Desc: 'تطبيق أندرويد تجاري متطور يوفر تجربة تسوق سلسة مع واجهة تصميم عصرية حديثة. يدعم الدفع الإلكتروني والتتبع الفوري.',
        app1CTA: 'حمله الآن',

        // التطبيق الثاني
        app2Title: 'تاسك برو أندرويد',
        app2Desc: 'تطبيق أندرويد متطور لإدارة المهام مع واجهة مستخدم ذكية. يتضمن ميزات الذكاء الاصطناعي والمزامنة الفورية. زاد إنتاجية العملاء بنسبة 50%.',
        app2CTA: 'حمله الآن',
        
        // التطبيق الثالث
        app3Title: 'معرض الواجهات - معرض التصاميم',
        app3Desc: 'تطبيق أندرويد يعرض أحدث تصميمات واجهات المستخدم التي قمنا بإنشائها. واجهات مبتكرة تتبع أحدث معايير التصميم مع تأثيرات تفاعلية متطورة.',
        app3CTA: 'زيارة المعرض',
        
        // قسم الأخبار (Updates)
        updatesHeading: 'آخر الأخبار والمنشورات',
        post1Title: 'شراكة جديدة مع البنك السعودي',
        post1Desc: 'سعداء بالإعلان عن تعاوننا الاستراتيجي لتطوير تطبيق فين-تك برو الرائد في مجال التكنولوجيا المالية.',
        post1Link: 'اقرأ المزيد',
        post2Title: 'إطلاق ميزة المساعد الذكي الجديدة',
        post2Desc: 'قمنا بتحديث تطبيق مدير المهام برو بإضافة ميزة المساعد الذكي التي طال انتظارها، لتعزيز تجربة المستخدم بشكل كبير.',
        post2Link: 'اقرأ المزيد',
        
        // قسم التواصل (Contact)
        contactHeading: 'اتصل بنا',
        contactLead: 'فريقنا ينتظرك! تواصل معنا اليوم لتحويل فكرتك إلى واقع. أرسل لنا رسالة أو تواصل عبر البيانات أدناه.',
        contactPhoneLabel: 'الهاتف',
        contactPhoneDesc: 'للاتصال المباشر والاستفسار الفوري',
        directCallBtn: 'اتصال مباشر',
        whatsappBtn: 'WhatsApp',
        contactFormTitle: 'أرسل لنا رسالة',
        sendBtn: 'إرسال الرسالة',
        
        // الخدمات في النموذج
        serviceDefault: 'اختر الخدمة المطلوبة',
        serviceAndroid: 'تطوير تطبيقات أندرويد',
        serviceUiux: 'تصميم واجهات المستخدم',
        serviceImprovement: 'تطوير وتحسين التطبيقات',
        serviceConsultation: 'استشارة تقنية',
        
        // نصوص الـ placeholders
        namePlaceholder: 'الاسم الكامل',
        emailPlaceholder: 'البريد الإلكتروني',
        phonePlaceholder: 'رقم الهاتف',
        messagePlaceholder: 'اكتب رسالتك هنا...',
        
        // التذييل
        footerServicesTitle: 'خدماتنا',
        footerContactTitle: 'تواصل معنا',
        footerServiceAndroid: 'تطوير أندرويد',
        footerServiceUiux: 'تصميم واجهات المستخدم',
        footerServiceImprovement: 'تحسين التطبيقات',
        footerText: '© 2024. CRO. جميع الحقوق محفوظة.'
    }
};

// ثوابت الاتصال العامة
const COMPANY_PHONE = '+964 780 099 9387';
const COMPANY_PHONE_TEL = '+9647800999387';

// مفاتيح ترجمة لرسائل الحالة
translations.en = {
    ...translations.en,
    sendSuccessTitle: 'Your message has been sent!',
    sendSuccessDesc: 'We received your message. Our team will contact you soon.',
    sendMailtoOpenedTitle: 'Your email app was opened to send your message.',
    sendMailtoFinalStepTitle: 'Final step:',
    sendMailtoFinalStepText: 'Click "Send" in your email app to actually send.',
    whatsappHint: 'Or contact us directly via WhatsApp.',
    quickPhone: 'Quick phone contact:',
    requiredFields: 'Please fill in all required fields.',
    sendingAuto: 'Sending...',
    callUnsupportedTitle: "Direct calling isn't supported on this device.",
    callNumberCopied: 'The phone number has been copied to your clipboard.',
    callManualDial: 'Please dial:'
};

translations.ar = {
    ...translations.ar,
    sendSuccessTitle: 'تم إرسال رسالتك!',
    sendSuccessDesc: 'استلمنا رسالتك. سنتواصل معك قريباً.',
    sendMailtoOpenedTitle: 'تم فتح تطبيق البريد لإرسال رسالتك.',
    sendMailtoFinalStepTitle: 'خطوة أخيرة:',
    sendMailtoFinalStepText: 'اضغط "إرسال/Send" في تطبيق البريد لإرسال الرسالة فعلياً.',
    whatsappHint: 'أو تواصل معنا مباشرة عبر واتساب.',
    quickPhone: 'للتواصل السريع عبر الهاتف:',
    requiredFields: 'يرجى تعبئة جميع الحقول المطلوبة.',
    sendingAuto: 'جارٍ الإرسال...',
    callUnsupportedTitle: 'الاتصال الفوري غير مدعوم على هذا الجهاز.',
    callNumberCopied: 'تم نسخ رقم الهاتف إلى الحافظة.',
    callManualDial: 'يرجى الاتصال بالرقم:'
};

// جلب اللغة الحالية
function getCurrentLang() {
    return localStorage.getItem('preferredLanguage') || document.documentElement.getAttribute('lang') || 'ar';
}

function setLanguage(lang) {
    // 1. تبديل النصوص
    const currentTrans = translations[lang];
    for (const key in currentTrans) {
        const element = document.getElementById(key);
        if (element) {
            // استخدام innerHTML للحفاظ على تنسيق Bold في بعض النصوص
            element.innerHTML = currentTrans[key]; 
        }
    }

    // 2. تبديل placeholders للحقول
    const placeholderElements = document.querySelectorAll('[data-placeholder-key]');
    placeholderElements.forEach(element => {
        const placeholderKey = element.getAttribute('data-placeholder-key');
        if (currentTrans[placeholderKey]) {
            element.setAttribute('placeholder', currentTrans[placeholderKey]);
        }
    });

    // 3. تبديل الاتجاه (Direction) والـ lang attribute
    const htmlElement = document.documentElement;
    if (lang === 'ar') {
        htmlElement.setAttribute('lang', 'ar');
        htmlElement.setAttribute('dir', 'rtl');
    } else {
        htmlElement.setAttribute('lang', 'en');
        htmlElement.setAttribute('dir', 'ltr');
    }

    // 4. تبديل حالة الأزرار
    document.getElementById('langAr').classList.remove('active');
    document.getElementById('langEn').classList.remove('active');
    document.getElementById('lang' + (lang === 'ar' ? 'Ar' : 'En')).classList.add('active');
}

// كشف الجهاز المحمول
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|Windows Phone/i.test(navigator.userAgent);
}

// نسخ إلى الحافظة
async function copyToClipboard(text) {
    try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            return true;
        }
    } catch (_) {}
    // fallback
    const input = document.createElement('input');
    input.value = text;
    document.body.appendChild(input);
    input.select();
    input.setSelectionRange(0, text.length);
    try { document.execCommand('copy'); } catch (_) {}
    document.body.removeChild(input);
    return true;
}

// تهيئة زر الاتصال المباشر
function setupDirectCallButton() {
    const link = document.getElementById('directCallLink');
    if (!link) return;
    const tel = link.getAttribute('data-phone-tel') || COMPANY_PHONE_TEL;
    const display = link.getAttribute('data-phone-display') || COMPANY_PHONE;
    // تأكيد ضبط href
    link.setAttribute('href', `tel:${tel}`);

    link.addEventListener('click', async function (e) {
        const lang = getCurrentLang();
        const t = translations[lang] || translations['ar'];
        if (!isMobileDevice()) {
            e.preventDefault();
            await copyToClipboard(display);
            const statusEl = document.getElementById('formStatus');
            if (statusEl) {
                statusEl.innerHTML = `📞 <strong>${t.callUnsupportedTitle}</strong><br><small>${t.callNumberCopied}</small><br><small>${t.callManualDial} <a href="tel:${tel}">${display}</a></small>`;
                statusEl.classList.add('show', 'success');
            } else {
                alert(`${t.callUnsupportedTitle}\n${t.callNumberCopied}\n${t.callManualDial} ${display}`);
            }
        } else {
            // على الأجهزة المدعومة، اترك المتصفح يتابع الرابط tel:
        }
    });
}

// دوال مساعدة للتحقق من توفر الخادم
function checkServerAvailability() {
    return fetch('http://localhost:3000/api/contact', {
        method: 'HEAD',
        timeout: 2000
    })
    .then(() => true)
    .catch(() => false);
}

// دالة إرسال عبر mailto كبديل
function sendViaMailto(formData) {
    const serviceNames = {
        android: 'تطوير تطبيقات أندرويد',
        uiux: 'تصميم واجهات المستخدم',
        improvement: 'تطوير وتحسين التطبيقات',
        consultation: 'استشارة تقنية'
    };
    
    const serviceName = serviceNames[formData.service] || formData.service;
    const subject = `رسالة جديدة من ${formData.name} - ${serviceName}`;
    
    const body = `مرحبا،

الاسم: ${formData.name}
البريد الإلكتروني: ${formData.email}
الهاتف: ${formData.phone || 'غير محدد'}
الخدمة المطلوبة: ${serviceName}

الرسالة:
${formData.message}

---
تم الإرسال عبر موقع CRO`;
    
    const mailtoLink = `mailto:nkslssk1987@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.open(mailtoLink, '_blank');
}

// إضافة وظائف جديدة
// إعداد EmailJS
function initializeEmailJS() {
    emailjs.init("YOUR_PUBLIC_KEY"); // سيتم استبداله بالمفتاح الحقيقي
}

// إرسال بريد تلقائي باستخدام EmailJS
function sendEmailDirectly(formData) {
    const serviceNames = {
        android: 'تطوير تطبيقات أندرويد',
        uiux: 'تصميم واجهات المستخدم',
        improvement: 'تطوير وتحسين التطبيقات',
        consultation: 'استشارة تقنية'
    };

    const templateParams = {
        from_name: formData.name,
        from_email: formData.email,
        phone: formData.phone || 'غير محدد',
        service: serviceNames[formData.service] || formData.service,
        message: formData.message,
        to_email: 'nkslssk1987@gmail.com'
    };

    // إرسال فوري باستخدام خدمة مجانية
    return fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({
            access_key: '2a3e3466-5f3d-46ee-8178-23e0a2d6aeb3', // مفتاح مؤقت للاختبار
            name: formData.name,
            email: formData.email,
            phone: formData.phone,
            subject: `رسالة جديدة من ${formData.name} - ${serviceNames[formData.service] || formData.service}`,
            message: `الاسم: ${formData.name}\nالبريد الإلكتروني: ${formData.email}\nرقم الهاتف: ${formData.phone || 'غير محدد'}\nالخدمة المطلوبة: ${serviceNames[formData.service] || formData.service}\n\nرسالة العميل:\n${formData.message}\n\n---\nتم الإرسال عبر موقع CRO الرسمي`,
            to: 'nkslssk1987@gmail.com',
            from: formData.email,
            replyto: formData.email
        })
    });
}

function handleContactForm() {
    const form = document.getElementById('contactForm');
    const statusEl = document.getElementById('formStatus');
    const sendBtn = document.getElementById('sendBtn');

    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // إعادة تعيين الحالة
            if (statusEl) {
                statusEl.className = 'form-status';
                statusEl.textContent = '';
                statusEl.classList.remove('show');
            }

            // جمع بيانات النموذج
            const formData = {
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                service: document.getElementById('service').value,
                message: document.getElementById('message').value.trim()
            };

            // اللغة الحالية
            const lang = getCurrentLang();
            const t = translations[lang] || translations['ar'];

            // تحقق بسيط من الصحة
            if (!formData.name || !formData.email || !formData.service || !formData.message) {
                if (statusEl) {
                    statusEl.textContent = t.requiredFields;
                    statusEl.classList.add('show', 'error');
                }
                return;
            }

            // تحضير حالة الإرسال
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.textContent = t.sendingAuto || '...';
            }

            try {
                // محاولة الإرسال التلقائي أولاً
                const response = await sendEmailDirectly(formData);
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // نجح الإرسال التلقائي
                        if (statusEl) {
                            statusEl.innerHTML = `
                                ✅ <strong>${t.sendSuccessTitle}</strong><br>
                                <small>${t.sendSuccessDesc}</small><br>
                                <small>📞 ${t.quickPhone} <a href="tel:${COMPANY_PHONE_TEL}">${COMPANY_PHONE}</a></small>
                            `;
                            statusEl.classList.add('show', 'success');
                        }
                        form.reset();
                        return;
                    }
                }
                
                // إذا فشل الإرسال التلقائي، استخدم mailto
                throw new Error('Direct send failed');
                
            } catch (err) {
                console.log('فشل الإرسال التلقائي، استخدام mailto كبديل:', err.message);
                
                // استخدام mailto كبديل
                sendViaMailto(formData);
                
                if (statusEl) {
                    statusEl.innerHTML = `
                        ✅ <strong>${t.sendMailtoOpenedTitle}</strong><br>
                        <small><strong>${t.sendMailtoFinalStepTitle}</strong> ${t.sendMailtoFinalStepText}</small><br>
                        <small>💬 ${t.whatsappHint}</small><br>
                        <small>📞 ${t.quickPhone} <a href="tel:${COMPANY_PHONE_TEL}">${COMPANY_PHONE}</a></small>
                    `;
                    statusEl.classList.add('show', 'success');
                }
                form.reset();
            } finally {
                if (sendBtn) {
                    const langFinal = getCurrentLang();
                    const tFinal = translations[langFinal] || translations['ar'];
                    sendBtn.disabled = false;
                    sendBtn.textContent = tFinal.sendBtn || 'Send';
                }
            }
        });
    }
}

// إضافة تأثيرات تفاعلية للبطاقات
function addInteractiveEffects() {
    // تأثير hover للبطاقات
    const cards = document.querySelectorAll('.app-card, .service-item, .update-card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
}

// تحسين دالة تبديل اللغة مع حفظ التفضيل
function setLanguage(lang) {
    // 1. تبديل النصوص
    const currentTrans = translations[lang];
    for (const key in currentTrans) {
        const element = document.getElementById(key);
        if (element) {
            // استخدام innerHTML للحفاظ على تنسيق Bold في بعض النصوص
            element.innerHTML = currentTrans[key]; 
        }
    }

    // 2. تبديل placeholders للحقول
    const placeholderElements = document.querySelectorAll('[data-placeholder-key]');
    placeholderElements.forEach(element => {
        const placeholderKey = element.getAttribute('data-placeholder-key');
        if (currentTrans[placeholderKey]) {
            element.setAttribute('placeholder', currentTrans[placeholderKey]);
        }
    });

    // 3. تبديل الاتجاه (Direction) والـ lang attribute
    const htmlElement = document.documentElement;
    if (lang === 'ar') {
        htmlElement.setAttribute('lang', 'ar');
        htmlElement.setAttribute('dir', 'rtl');
    } else {
        htmlElement.setAttribute('lang', 'en');
        htmlElement.setAttribute('dir', 'ltr');
    }

    // 4. تبديل حالة الأزرار
    document.getElementById('langAr').classList.remove('active');
    document.getElementById('langEn').classList.remove('active');
    document.getElementById('lang' + (lang === 'ar' ? 'Ar' : 'En')).classList.add('active');
    
    // 5. حفظ تفضيل اللغة
    localStorage.setItem('preferredLanguage', lang);
}

// تهيئة الموقع عند التحميل
function initializeWebsite() {
    // تشغيل مكتبة AOS
    AOS.init({
        duration: 1000,    // مدة ظهور التأثير بالملي ثانية
        once: true,        // التأثير يحدث مرة واحدة فقط عند النزول
        mirror: false,     // لا يحدث التأثير عند الصعود للأعلى
        offset: 50,        // المسافة قبل بدء التأثير
    });
    
    // قراءة اللغة المفضلة من التخزين المحلي
    const savedLanguage = localStorage.getItem('preferredLanguage') || 'ar';
    setLanguage(savedLanguage);

    // تهيئة زر الاتصال المباشر
    setupDirectCallButton();
    
    // تفعيل نموذج الاتصال
    handleContactForm();
    
    // إضافة تأثيرات تفاعلية
    addInteractiveEffects();
    
    // إضافة smooth scroll للروابط
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
}

// تشغيل الموقع عند التحميل الكامل
window.addEventListener('load', initializeWebsite);
